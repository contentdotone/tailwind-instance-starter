<section class="bg-slate-50 px-4 py-12 sm:px-6 lg:px-8">
  <div class="mx-auto w-full max-w-6xl">
    <div class="flex flex-col gap-3">
      <p class="text-xs font-semibold uppercase tracking-[0.24em] text-slate-500">Story Stream</p>
      <h2 class="text-3xl font-semibold text-slate-900 sm:text-4xl">Latest community stories</h2>
      <p class="max-w-2xl text-sm text-slate-600">Fresh updates from supporters and volunteers in the field.</p>
    </div>

    <div id="story-stream" class="mt-8 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <div class="flex items-center gap-3 text-sm text-slate-500">
          <i class="fas fa-circle-notch fa-spin text-brand" aria-hidden="true"></i>
          <span>Loading stories…</span>
        </div>
      </div>
    </div>
  </div> 
</section>
 
<script>
    {{$defaultZUID = 7-8c98b987bf-l3cdp4}}
    {{if {!this.causecircle_id} }}
    {{$defaultZUID = {this.causecircle_id} }}
    {{/if}}
  (() => { 
    const container = document.getElementById("story-stream");
    if (!container) return;
    const endpoint = "https://api.causecircle.org/stories?npo={{$defaultZUID}}&status=approved";

    const stripHtml = (html) => (html || "").replace(/<[^>]*>/g, "");
    const getImageUrl = (story) => {
      const data = story?.story_image?.data || [];
      const image = data.find((item) => item.type === "image");
      return image?.url || "";
    };

    const renderCard = (story) => {
      const title = story?.title || "Untitled story";
      const body = stripHtml(story?.story_body).slice(0, 140);
      const url = story?.story_url || story?.meta?.web?.uri || "#";
      const image = getImageUrl(story);
      const author = story?.author?.data?.[0];
      const authorName = author ? `${author.first_name || ""} ${author.last_name || ""}`.trim() : "";

      return `
        <article class="flex h-full flex-col overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm transition hover:-translate-y-1 hover:shadow-lg">
          <div class="aspect-video w-full bg-slate-100">
            ${image ? `<img src="${image}" alt="${title}" class="h-full w-full object-cover" loading="lazy">` : ""}
          </div>
          <div class="flex h-full flex-col p-5">
            <h3 class="text-lg font-semibold text-slate-900">${title}</h3>
            <p class="mt-3 text-sm text-slate-600">${body}${body ? "…" : ""}</p>
            ${authorName ? `<p class="mt-4 text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">By ${authorName}</p>` : ""}
            <a target="_blank" href="${url}" class="mt-4 inline-flex text-xs font-semibold uppercase tracking-[0.2em] text-brand">Read story</a>
          </div>
        </article>
      `;
    };

    const renderError = () => {
      container.innerHTML = `
        <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
          <p class="text-sm text-slate-500">Unable to load stories right now.</p>
        </div>
      `;
    };

    fetch(endpoint)
      .then((response) => (response.ok ? response.json() : Promise.reject()))
      .then((payload) => {
        const stories = payload?.data || [];
        if (!stories.length) {
          container.innerHTML = `
            <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
              <p class="text-sm text-slate-500">No stories available yet.</p>
            </div>
          `;
          return;
        }
        container.innerHTML = stories.slice(0, 6).map(renderCard).join("");
      })
      .catch(renderError);
  })();
</script>
