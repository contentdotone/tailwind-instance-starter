<div class="hidden flex-1 items-center justify-center md:flex">
  <div class="relative w-full max-w-md">
    <label for="site-search" class="sr-only">Search</label>
    <div class="flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm text-slate-600 shadow-sm focus-within:border-brand focus-within:ring-2 focus-within:ring-brand/20">
      <i class="fas fa-search text-slate-400" aria-hidden="true"></i>
      <input
        id="site-search"
        type="search"
        placeholder="Search articles and locations"
        class="w-full bg-transparent text-sm text-slate-700 placeholder:text-slate-400 focus:outline-none"
        autocomplete="off"
      />
    </div>
    <div
      id="search-results"
      class="absolute left-0 right-0 top-full z-50 mt-3 hidden max-h-[420px] overflow-auto rounded-2xl border border-slate-200 bg-white shadow-xl"
    >
      <div class="px-4 py-3 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Search results</div>
      <div id="search-results-content" class="space-y-4 px-4 pb-4"></div>
    </div>
  </div>
</div>
 
<script>
  (() => {
    const input = document.getElementById("site-search");
    const results = document.getElementById("search-results");
    const resultsContent = document.getElementById("search-results-content");
    if (!input || !results || !resultsContent) return;

    let debounceTimer;
    let lastQuery = "";

    const getItemUrl = (item, type) => {
      if (item.meta && item.meta.web && item.meta.web.uri) return item.meta.web.uri;
      if (item.web && item.web.uri) return item.web.uri;
      if (item.uri) return item.uri;
      if (item.url) return item.url;
      if (item.slug) return `/${type}/${item.slug}`;
      return "#";
    };

    const renderItems = (label, items, type) => {
      if (!items || !items.length) return "";
      const cards = items
        .map((item) => {
          const title = item.title || item.location_name || "Untitled";
          const image = item.main_image || item.main_image?.getImage?.() || "";
          const description = item.subtitle || item.content || "";
          const text = typeof description === "string" ? description.replace(/<[^>]*>/g, "").slice(0, 120) : "";
          const url = getItemUrl(item, type);
          return `
            <a href="${url}" class="group flex items-center gap-3 rounded-xl border border-slate-200 bg-white p-3 transition hover:border-brand/40 hover:bg-slate-50">
              <div class="h-16 w-24 flex-shrink-0 overflow-hidden rounded-lg bg-slate-100">
                ${image ? `<img src="${image}" alt="${title}" class="h-full w-full object-cover" loading="lazy">` : ""}
              </div>
              <div class="min-w-0">
                <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">${label}</p>
                <p class="truncate text-sm font-semibold text-slate-800">${title}</p>
                <p class="mt-1 line-clamp-2 text-xs text-slate-500">${text}</p>
              </div>
            </a>
          `;
        })
        .join("");
      return `<div class="space-y-3">${cards}</div>`;
    };

    const renderResults = (data) => {
      const articles = renderItems("Article", data.articles || [], "articles");
      const locations = renderItems("Location", data.locations || [], "locations");
      const html = [articles, locations].filter(Boolean).join('<div class="h-px bg-slate-100"></div>');
      resultsContent.innerHTML = html || `<p class="text-sm text-slate-500">No results found.</p>`;
    };

    const openResults = () => {
      results.classList.remove("hidden");
    };

    const closeResults = () => {
      results.classList.add("hidden");
    };

    const handleSearch = async (query) => {
      if (!query || query.length < 2) {
        resultsContent.innerHTML = "";
        closeResults();
        return;
      }
      try {
        const response = await fetch(`/api/search.json?q=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error("Search failed");
        const data = await response.json();
        renderResults(data);
        openResults();
      } catch (error) {
        resultsContent.innerHTML = `<p class="text-sm text-slate-500">Unable to load results.</p>`;
        openResults();
      }
    };

    input.addEventListener("input", (event) => {
      const query = event.target.value.trim();
      if (query === lastQuery) return;
      lastQuery = query;
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => handleSearch(query), 300);
    }); 

    input.addEventListener("focus", () => {
      if (resultsContent.innerHTML.trim()) {
        openResults();
      }
    });

    document.addEventListener("click", (event) => {
      if (!results.contains(event.target) && event.target !== input) {
        closeResults();
      }
    });
  })();
</script>
